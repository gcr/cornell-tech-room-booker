// Generated by LiveScript 1.4.0
(function(){
  var parseEventsToMoments, momentToMidnightMinutes, makeCurrentTimeRange, batchFunctionCallsIntoList, AvailabilityStore, availabilityStore, out$ = typeof exports != 'undefined' && exports || this;
  parseEventsToMoments = function(events, whichDay){
    var resultEvents, i$, len$, ref$, start, end, busy, thisMorning, thisEvening, endIntersection, startIntersection;
    resultEvents = [];
    for (i$ = 0, len$ = events.length; i$ < len$; ++i$) {
      ref$ = events[i$], start = ref$.start, end = ref$.end, busy = ref$.busy;
      thisMorning = moment(whichDay).startOf('day');
      thisEvening = moment(whichDay).endOf('day');
      start = moment.utc(start);
      end = moment.utc(end);
      endIntersection = moment.min(end, thisEvening);
      startIntersection = moment.max(start, thisMorning);
      if (endIntersection.diff(startIntersection) > 0) {
        resultEvents.push({
          start: startIntersection,
          end: endIntersection
        });
      }
    }
    return resultEvents;
  };
  out$.momentToMidnightMinutes = momentToMidnightMinutes = function(point){
    return point.diff(moment(point).local().startOf('day')) / 1000.0 / 60.0;
  };
  makeCurrentTimeRange = function(){
    var nowMinutes, startMinutes;
    nowMinutes = momentToMidnightMinutes(moment());
    startMinutes = Math.floor(nowMinutes / 30.0) * 30.0;
    return {
      start: startMinutes,
      end: startMinutes + 30
    };
  };
  batchFunctionCallsIntoList = function(timeout, f){
    var args, timer;
    args = [];
    timer = null;
    return function(x){
      args.push(x);
      if (timer === null) {
        return timer = setTimeout(function(){
          return f(args);
        }, timeout);
      }
    };
  };
  out$.AvailabilityStore = AvailabilityStore = (function(){
    AvailabilityStore.displayName = 'AvailabilityStore';
    var prototype = AvailabilityStore.prototype, constructor = AvailabilityStore;
    function AvailabilityStore(){
      this.attentionRooms = [];
      this.attentionRoomStatus = {};
      this.selectedRoom = null;
      this.attentionFloor = null;
      this.currentTimeRange = makeCurrentTimeRange();
      this.attentionDay = moment();
      this.nowMinute = momentToMidnightMinutes(moment());
      this.cachedRoomData = {};
      this.queryDebounceRooms = [];
      this.queryServerPromise = null;
    }
    prototype.highlightHalfHourBlock = function(hour){
      this.currentTimeRange.start = hour * 60;
      this.currentTimeRange.end = hour * 60 + 30;
      return this.updateAttentionRoomStatus();
    };
    prototype.loadRoomData = function(roomNetid){
      var uniqueRoomId;
      uniqueRoomId = this.attentionDay.format() + roomNetid;
      if (!(uniqueRoomId in this.cachedRoomData)) {
        Vue.set(this.cachedRoomData, uniqueRoomId, {
          loaded: false,
          events: [],
          errorMessage: "",
          date: this.attentionDay.format()
        });
        this.queryDebounceRooms.push({
          netid: roomNetid,
          date: this.attentionDay.format(),
          uniqueRoomId: uniqueRoomId
        });
        this.queryServerForAvailabilities();
      }
      return this.cachedRoomData[uniqueRoomId];
    };
    prototype.bumpAttentionDay = function(range){
      var oldSelectedRoom, r;
      this.queryServerPromise = null;
      this.queryDebounceRooms = [];
      this.attentionDay = moment(this.attentionDay.add(range, 'day'));
      this.cachedRoomData = {};
      oldSelectedRoom = this.selectedRoom;
      this.setAttentionRooms((function(){
        var i$, ref$, len$, results$ = [];
        for (i$ = 0, len$ = (ref$ = this.attentionRooms).length; i$ < len$; ++i$) {
          r = ref$[i$];
          results$.push(r);
        }
        return results$;
      }.call(this)));
      return this.selectedRoom = oldSelectedRoom;
    };
    prototype.queryServerForAvailabilities = function(){
      var this$ = this;
      if (this.queryServerPromise) {
        return this.queryServerPromise;
      } else {
        return this.queryServerPromise = new Promise(function(resolve, reject){
          return setTimeout(function(){
            var date, roomNetidHash, res$, id, ref$, data, roomNetids, netid, _;
            date = this$.attentionDay.format();
            console.log("Retrieving rooms for", date);
            res$ = {};
            for (id in ref$ = this$.queryDebounceRooms) {
              data = ref$[id];
              res$[data.netid] = true;
            }
            roomNetidHash = res$;
            res$ = [];
            for (netid in roomNetidHash) {
              _ = roomNetidHash[netid];
              res$.push(netid);
            }
            roomNetids = res$;
            return $.ajax({
              dataType: 'json',
              method: 'POST',
              url: '/availability',
              data: {
                rooms: roomNetids,
                dateString: date
              },
              error: function(err){
                this$.queryDebounceRooms = [];
                this$.queryServerPromise = null;
                return reject(err);
              },
              success: function(arg$){
                var ok, err, roomNetid, ref$, errorMessage, events, uniqueRoomId, oldEvents, i$, len$, ev;
                ok = arg$.ok, err = arg$.err;
                this$.queryDebounceRooms = [];
                this$.queryServerPromise = null;
                if (err) {
                  return reject(err);
                } else {
                  console.log(date, this$.cachedRoomData);
                  for (roomNetid in ok) {
                    ref$ = ok[roomNetid], errorMessage = ref$.errorMessage, events = ref$.events;
                    uniqueRoomId = date + roomNetid;
                    if (uniqueRoomId in this$.cachedRoomData) {
                      this$.cachedRoomData[uniqueRoomId].errorMessage = errorMessage;
                      this$.cachedRoomData[uniqueRoomId].loaded = true;
                      oldEvents = this$.cachedRoomData[uniqueRoomId].events;
                      oldEvents.splice(0);
                      for (i$ = 0, len$ = (ref$ = parseEventsToMoments(events, this$.attentionDay)).length; i$ < len$; ++i$) {
                        ev = ref$[i$];
                        oldEvents.push(ev);
                      }
                      this$.updateAttentionRoomStatus();
                    }
                  }
                  return resolve();
                }
              }
            });
          }, 100);
        });
      }
    };
    prototype.timeSelected = function(startMin, endMin){
      return Math.max(this.currentTimeRange.start, startMin) < Math.min(this.currentTimeRange.end, endMin);
    };
    prototype.eventSelected = function(arg$){
      var start, end;
      start = arg$.start, end = arg$.end;
      return this.timeSelected(momentToMidnightMinutes(start), momentToMidnightMinutes(end));
    };
    prototype.updateAttentionRoomStatus = function(){
      var i$, ref$, len$, roomid, lresult$, roomData, j$, ref1$, len1$, event, results$ = [];
      for (i$ = 0, len$ = (ref$ = this.attentionRooms).length; i$ < len$; ++i$) {
        roomid = ref$[i$];
        lresult$ = [];
        Vue['delete'](this.attentionRoomStatus, roomid);
        roomData = this.loadRoomData(roomid);
        if (!roomData.loaded) {
          lresult$.push(Vue.set(this.attentionRoomStatus, roomid, "Loading"));
        } else {
          Vue.set(this.attentionRoomStatus, roomid, "Available");
          for (j$ = 0, len1$ = (ref1$ = roomData.events).length; j$ < len1$; ++j$) {
            event = ref1$[j$];
            if (this.eventSelected(event)) {
              lresult$.push(Vue.set(this.attentionRoomStatus, roomid, "Booked"));
            }
          }
        }
        results$.push(lresult$);
      }
      return results$;
    };
    prototype.setAttentionRooms = function(newRoomIds){
      var i$, len$, id;
      this.selectRoom(null);
      this.attentionRooms.splice(0);
      for (i$ = 0, len$ = newRoomIds.length; i$ < len$; ++i$) {
        id = newRoomIds[i$];
        this.attentionRooms.push(id);
      }
      return this.updateAttentionRoomStatus();
    };
    prototype.setAttentionFloor = function(newFloorName){
      return this.attentionFloor = newFloorName;
    };
    prototype.selectRoom = function(roomid){
      if (this.selectedRoom === roomid) {
        return this.selectedRoom = null;
      } else {
        return this.selectedRoom = roomid;
      }
    };
    return AvailabilityStore;
  }());
  out$.availabilityStore = availabilityStore = new AvailabilityStore();
}).call(this);
